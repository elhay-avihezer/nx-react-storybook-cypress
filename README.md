# Testing with Cypress & Storybook

## Step 1 - project setup

------------------------------------

Creating the project (`workspace` in nx terminology)
```shell
npx create-nx-workspace --preset=react
```
Enter the following answers to the interactive shell 
```
✔ Workspace name (e.g., org name)     · cypress-storybook
✔ Application name                    · client
✔ Default stylesheet format           · scss
✔ Use Nx Cloud? (It's free and doesn't require registration.) · No
```

## Step 2 - Configuration

---------

Add Storybook plugin and update e2e tests with cypress to use storybook config
```shell
npm i -D @nrwl/storybook
```
```shell
npx nx g @nrwl/react:storybook-configuration client
```
Enter the following answers to the interactive shell
```
✔ Configure a cypress e2e app to run against the storybook instance? (Y/n) · true
✔ Automatically generate *.stories.ts files for components declared in this project? (Y/n) · true
✔ Automatically generate *.spec.ts files in the cypress e2e app generated by the cypress-configure generator? (Y/n) · true
```

## Step 3 - Let's see what weh'v got so far

---------
1. The app `npm start`
2. Storybook `npx nx run client:storybook`

## Step 4 - Let's generate a new component

---------
Generate component with unit tests
```shell
npx nx g @nrwl/react:component --project=client Counter --export
```
Generate the Storybook for the component
```shell
npx nx g @nrwl/react:component-story --project=client --componentPath=app/counter/counter.tsx
```

Past this as component content `apps/client/src/app/counter/counter.tsx`
```typescript jsx
import { useState } from 'react';
import './counter.module.scss';
import styles from './counter.module.scss';

/* eslint-disable-next-line */
export interface CounterProps {}

export function Counter(props: CounterProps) {
  const [clicks, setClicks] = useState(0)
  return (
    <div>
      <span data-aid='+' className={styles.button} onClick={() => setClicks(n => n+1)}>+</span>
      <span className={styles.button} onClick={() => setClicks(n => n-1)}>-</span>
      <h1>Current number: {clicks}</h1>
    </div>
  );
}

export default Counter;
```
Past this as component style `apps/client/src/app/counter/counter.module.scss`
```scss
.button {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 1px solid grey;
  text-align: center;
  margin-right: 10px;
}
```

Create Cypress test file `apps/client-e2e/src/integration/app/counter.spec.ts` 
paste this 
```javascript
describe('client: App component', () => {
  before(() => cy.visit('/iframe.html?id=counter--primary'));

  it('should render the component', () => {
    cy.get('h1').should('contain', 'Current number: 0');
  });
  it('increase number', () => {
    cy.get('[data-aid="+"]').click();
    cy.get('h1').should('contain', 'Current number: 1');
  });
});
```

## Step 5 - Finally let's run the Cypress test against the `Counter` storybook

---------
Past this as e2e configuration in the `workspace.json` at project root
as value of `projects.client-e2e.targets.e2e`
```json
{
  "executor": "@nrwl/cypress:cypress",
  "options": {
    "cypressConfig": "apps/client-e2e/cypress.json",
    "devServerTarget": "client:storybook",
    "tsConfig": "apps/client-e2e/tsconfig.json"
  },
  "configurations": {
    "production": {
      "devServerTarget": "client:storybook:ci"
    }
  }
}
```

Configure tests base url by adding this `"baseUrl": "http://localhost:4400"` to `apps/client-e2e/cypress.json`

To run the test in interactive mode
```shell
npx nx run client-e2e:e2e --watch
```
